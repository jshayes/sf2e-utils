{
  "name": "Point Tracker",
  "type": "script",
  "command": "function parseInteger(value, fallback = 0) {\n  const text = String(value ?? \"\").trim();\n  if (!/^[+-]?\\d+$/.test(text)) return fallback;\n  return Number.parseInt(text, 10);\n}\n\nconst FLAG_SCOPE = \"event-based-token-changer\";\nconst FLAG_KEY = \"number-tracker-state\";\nconst savedState = game.user.getFlag(FLAG_SCOPE, FLAG_KEY);\nconst initialTrackers =\n  Array.isArray(savedState?.trackers) && savedState.trackers.length\n    ? savedState.trackers\n    : [{ name: \"\", value: 0 }];\n\nawait foundry.applications.api.DialogV2.wait({\n  window: { title: \"Number Tracker\" },\n  content: `\n    <div data-tracker-list></div>\n    <div class=\"form-group\">\n      <button type=\"button\" data-add-tracker>Add Tracker</button>\n    </div>\n  `,\n  render: (_event, dialog) => {\n    const root = dialog.element;\n    if (!root) return;\n\n    const trackerList = root.querySelector(\"[data-tracker-list]\");\n    const addButton = root.querySelector(\"button[data-add-tracker]\");\n    if (!(trackerList instanceof HTMLElement)) return;\n    if (!(addButton instanceof HTMLButtonElement)) return;\n\n    const getStateFromDom = () => {\n      const trackers = Array.from(\n        trackerList.querySelectorAll(\".tracker-entry\"),\n      ).map((entry) => {\n        const nameInput = entry.querySelector('input[name=\"trackerName\"]');\n        const valueInput = entry.querySelector('input[name=\"trackerValue\"]');\n        return {\n          name:\n            nameInput instanceof HTMLInputElement ? nameInput.value.trim() : \"\",\n          value:\n            valueInput instanceof HTMLInputElement\n              ? parseInteger(valueInput.value, 0)\n              : 0,\n        };\n      });\n\n      return { trackers };\n    };\n\n    const saveState = async () => {\n      await game.user.setFlag(FLAG_SCOPE, FLAG_KEY, getStateFromDom());\n    };\n\n    const attachEntryHandlers = (entryRoot) => {\n      const nameInput = entryRoot.querySelector('input[name=\"trackerName\"]');\n      const valueInput = entryRoot.querySelector('input[name=\"trackerValue\"]');\n      const removeButton = entryRoot.querySelector(\n        \"button[data-remove-tracker]\",\n      );\n\n      if (nameInput instanceof HTMLInputElement) {\n        nameInput.addEventListener(\"change\", () => void saveState());\n      }\n      if (!(valueInput instanceof HTMLInputElement)) return;\n      if (removeButton instanceof HTMLButtonElement) {\n        removeButton.addEventListener(\"click\", () => {\n          entryRoot.remove();\n          if (!trackerList.querySelector(\".tracker-entry\")) {\n            addTrackerEntry();\n          }\n          void saveState();\n        });\n      }\n\n      for (const button of entryRoot.querySelectorAll(\"button[data-adjust]\")) {\n        button.addEventListener(\"click\", () => {\n          const delta = parseInteger(button.dataset.adjust, 0);\n          const current = parseInteger(valueInput.value, 0);\n          valueInput.value = String(current + delta);\n          valueInput.focus();\n          valueInput.select();\n          void saveState();\n        });\n      }\n\n      valueInput.addEventListener(\"change\", () => void saveState());\n    };\n\n    const addTrackerEntry = (tracker = { name: \"\", value: 0 }) => {\n      const entry = document.createElement(\"div\");\n      entry.classList.add(\"tracker-entry\");\n      entry.style.marginBottom = \"0.75rem\";\n      entry.innerHTML = `\n        <div class=\"form-group\" style=\"margin-bottom: 0.5rem;\">\n          <label>Name</label>\n          <div class=\"form-fields\" style=\"gap: 0.25rem;\">\n            <input type=\"text\" name=\"trackerName\" placeholder=\"e.g. Victory Points\" value=\"${foundry.utils.escapeHTML(tracker.name ?? \"\")}\" />\n            <button type=\"button\" data-remove-tracker aria-label=\"Remove tracker\">X</button>\n          </div>\n        </div>\n        <div class=\"form-group\">\n          <label>Value</label>\n          <div class=\"form-fields\" style=\"gap: 0.25rem;\">\n            <button type=\"button\" data-adjust=\"-1\" aria-label=\"Decrease value\">-</button>\n            <input type=\"number\" name=\"trackerValue\" step=\"1\" value=\"${parseInteger(tracker.value, 0)}\" />\n            <button type=\"button\" data-adjust=\"1\" aria-label=\"Increase value\">+</button>\n          </div>\n        </div>\n      `;\n      trackerList.append(entry);\n      attachEntryHandlers(entry);\n    };\n\n    addButton.addEventListener(\"click\", () => {\n      addTrackerEntry();\n      void saveState();\n    });\n\n    for (const tracker of initialTrackers) {\n      addTrackerEntry({\n        name: typeof tracker?.name === \"string\" ? tracker.name : \"\",\n        value: parseInteger(tracker?.value, 0),\n      });\n    }\n  },\n  buttons: [\n    {\n      action: \"close\",\n      label: \"Close\",\n      default: true,\n    },\n  ],\n  rejectClose: false,\n  modal: false,\n});",
  "img": "icons/svg/dice-target.svg",
  "author": "TLAWqblZZCmBRUYz",
  "scope": "global",
  "folder": null,
  "ownership": {
    "default": 0,
    "TLAWqblZZCmBRUYz": 3
  },
  "flags": {},
  "_stats": {
    "compendiumSource": null,
    "duplicateSource": null,
    "exportSource": null,
    "coreVersion": "13.351",
    "systemId": "sf2e",
    "systemVersion": "0.0.4",
    "createdTime": 1771108122595,
    "modifiedTime": 1771108122595,
    "lastModifiedBy": "TLAWqblZZCmBRUYz"
  },
  "_id": "1smZ58SiLAGj0Pcg",
  "sort": 0,
  "_key": "!macros!1smZ58SiLAGj0Pcg"
}
